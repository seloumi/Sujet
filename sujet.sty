%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  XeLaTeX Template
% (22/2/2018)
%
% author:
% Salim bou (salimcollo7@gmail.com)
% 
% Important notes:
% This template needs to be compiled with XeLaTeX 
% Used fonts: Amiri, AlBattar, Traditional Arabic
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{sujet}[2018/02/14]


%%%%%%%%%%%%
% packages %
%%%%%%%%%%%%

\RequirePackage{etoolbox}
\RequirePackage[nomessages]{fp}% for arithmetic calc
\RequirePackage[margin=2cm]{geometry}
\RequirePackage{amsmath,amsfonts,amssymb}
\RequirePackage{tikz}
\RequirePackage[totpages,user]{zref}
\RequirePackage[explicit,compact]{titlesec}
\RequirePackage{fancyhdr}
\RequirePackage{array}    
\RequirePackage{longtable}    



\newcount\c@nbrlignes
\c@nbrlignes=2

\newdimen\d@lastcol
\d@lastcol=\dimexpr .125\textwidth-3\tabcolsep-2\arrayrulewidth\relax 

\newdimen\d@addnote
\d@addnote=\dimexpr 2\tabcolsep+\arrayrulewidth+.5\d@lastcol\relax


\newif \if@nom           \@nomfalse
\newif \if@LTR           \@LTRfalse
\newif \if@border        \@bordertrue
\newif \if@correction    \@correctionfalse
\newif \if@stretchtable  \@stretchtablefalse


\def\settempdimen{\newdimen\tempn \tempn=.5\arrayrulewidth \advance \tempn by \tabcolsep\relax}

\def\tikzmark#1{\tikz[remember picture,overlay]\node(#1)[inner sep=0pt]{};}

\def\stretchtable{%
	\global\@stretchtabletrue%
	\settempdimen\hbox to \hsize{\hbox to 0pt{\hss\tikzmark{A}\hskip\tempn}\hfill\hbox to 0pt{\hskip\tempn\tikzmark{B}\hss}}&
	\settempdimen\hbox to \hsize{\hbox to 0pt{}\hfill\hbox to 0pt{\hskip\tempn\tikzmark{C}\hss}}&
	\settempdimen\hbox to \hsize{\hfill\hbox to 0pt{\hskip\tempn\tikzmark{D}\hss}}\\ }

\edef\result{0}

\def\@nte#1{\FPadd\result\result{#1}\FPclip\result\result\global\edef\result{\result}%
\vadjust{\vbox to 0pt{\vss%
\hbox to \hsize{\hskip\hsize\hskip\d@addnote \hbox to 0pt{\hss#1\hss} \hss}%
\vskip.8ex}}}

\def\@Nte#1{%
\advance \d@addnote by \dimexpr  2\tabcolsep+\d@lastcol+\arrayrulewidth\relax%
\vadjust{\vbox to 0pt{\vss%
\hbox to \hsize{\hskip\hsize\hskip\d@addnote \hbox to 0pt{\hss#1\hss} \hss}%
\vskip.8ex}}}


\def~#1:#2{%
\def\plus{+}\def\equa{=}%
\if#2\plus %
\@nte{#1}% 
\else 
\if#2\equa %
\@nte{#1}\@Nte{\result}\global\edef\result{0}%
\fi 
\fi   
}


\DeclareOption{correction}{
\def\nl{&&\\ }	
\@correctiontrue 
\newenvironment{correction}{
\begin{longtable}{|b{.75\textwidth}|>{\centering}b{\d@lastcol}|>{\centering\arraybackslash}b{\d@lastcol}|}
	\hline 
	\centering\sffamily\vtop to 0pt{\vskip0pt عناصر الإجابة\vss} & 
	\multicolumn{2}{c|}{\sffamily العلامة}\\
	\cline{2-3}
	& 
	\sffamily مـجزأة
	&
	\sffamily المجموع\\
	\hline   
}{
\end{longtable}
\if@stretchtable 
\begin{tikzpicture}[remember picture,overlay]
\draw[line width=\arrayrulewidth](A)|-([yshift=2cm]current page.south)-|(D);
\draw[line width=\arrayrulewidth](B)|-([yshift=2cm]current page.south)-|(C);
\end{tikzpicture}
\fi
}
}


\DeclareOption{landscape}{
	\geometry{landscape}
	\if@twocolumn 
	\newfontfamily\arabicfontsf[Script=Arabic,Scale=1]{AlBattar}
	\geometry{hmargin=1cm}	    
	\fi 
}

\DeclareOption*{\PackageWarning{sujet}{Unknown ‘\CurrentOption’ option}}

\ProcessOptions\relax



\RequirePackage{polyglossia}

% languages & fonts===========================================
\setdefaultlanguage[calendar=gregorian,numerals=maghrib]{arabic}
\setotherlanguage{english}
\newfontfamily\arabicfont[Script=Arabic,Scale=1.2]{Amiri}
\newfontfamily\arabicfontsf[Script=Arabic,Scale=1.2]{AlBattar} 
\newfontfamily\arabicfonttt[Script=Arabic]{Traditional Arabic}
\newfontfamily\englishfonttt{Latin Modern Mono}
%=============================================================


\def\copycolumn{\if@twocolumn\newpage\setbox\@outputbox=\vbox{\copy\@leftcolumn} \box\@outputbox  %
	\else \PackageWarning{sujet}{\noexpand\copycolumn used only with twocolumn option} \fi}


\tikzset{Rnode/.style={font=\beginR}}

\newcommand{\nombox}{
	\begin{tikzpicture}
	\draw [dotted](3mm,0)--(\columnwidth-3mm,0);
	\node[fill=white,left,Rnode] at (\columnwidth-3\pgflinewidth,0){اللقب والإسم:};
	\node[fill=white,left,yshift=2pt,Rnode] at (0.25\columnwidth,0){العلامة:};
	\draw [rounded corners,thick](0,-0.6)rectangle(\columnwidth-4\pgflinewidth,0.6);
	\end{tikzpicture}
	\par
}


\def\@annee{
\newcount\altyear
\altyear=\year
\ifnum\month>8 %
      \advance \altyear by 1 %
      \the\year\ -  \the\altyear
\else %
      \advance \altyear by -1 %
      \the\altyear\ - \the\year
\fi 
}

\def\annee{ السنة الدراسية:\@annee}

\newcommand{\etab}[1][ثانوية: اسم المؤسسة هنا ]
{#1}
\newcommand{\duree}[1][ساعة]
{المدة: #1}
\newcommand{\niveau}[1][1 ج م ع تك]
{المستوى: #1}
\newcommand{\nom}[1][false]{\csname nom#1\endcsname\if@nom\nombox \fi}

% define keys ================================================

\define@key{sujetkeys}{etab}{\renewcommand{\etab}[1]{#1}}
\define@key{sujetkeys}{niveau}{\renewcommand{\niveau}[1]{المستوى: #1}}
\define@key{sujetkeys}{duree}{\renewcommand{\duree}[1]{المدة: #1}}
\define@key{sujetkeys}{nom}[true]{\renewcommand{\nom}{\csname nom#1\endcsname\if@nom\nombox \fi}}
\define@key{solboxkeys}{lignes}{\c@nbrlignes=#1}
\define@key{solboxkeys}{LTR}[true]{\csname @LTR#1\endcsname}
\define@key{solboxkeys}{border}[true]{\csname @border#1\endcsname}


%define sujetset command  ======================================
\newcommand\sujetset[2][]{%
	\setkeys{sujetkeys}{#1}
	\pagestyle{fancy}
	\fancyhead{}% clear all header fields
	\renewcommand{\footrulewidth}{1pt}
	\renewcommand{\headrulewidth}{1pt}
	\chead{\sffamily \ifnum\thepage=1 \etab{}\hfill\ifGm@landscape\if@twocolumn\annee\hskip\columnsep\etab{}\fi\fi\hfill\annee\fi}
	\cfoot{\ifnum\ztotpages>1   \hfill  صفحة \thepage\ من \ztotpages \hfill  \ifGm@landscape صفحة \thepage\ من \ztotpages \hfill \fi\fi}
	\if@correction
	\else
	\long\gdef\head{%
	\begingroup 
	\sffamily\large\leavevmode\hfill  #2 \hfill\ \par
	\rule{\columnwidth}{1pt}
	\niveau\ \hfill \duree \par \endgroup}% 
	\head\nom
    \fi
}  

\setlength{\headsep}{15pt}% defaut 25pt
\setlength{\headheight}{15.4pt}
\setlength{\itemsep}{3cm}
\arraycolsep=1.4pt
\parindent=0pt

% box for solutions  ===========================================
\newcommand\solbox[2][]{%
	\setkeys{solboxkeys}{#1}
	\par
	\begin{tikzpicture}[thick]
	\foreach \i in{1,...,\the\c@nbrlignes}{\draw[dotted](5mm,\i)--(\linewidth-5mm,\i);}
	\ifLTR%
	\node[anchor=west,fill=white,xshift=-1mm,yshift=-0.1mm,inner sep=0pt,minimum size=0pt,align=left] at (5mm,\the\c@nbrlignes){#2};
	\else
	\node[anchor=east,fill=white,xshift=1mm,yshift=0.3mm,inner sep=0pt,minimum size=0pt,Rnode] at (\linewidth-5mm,\the\c@nbrlignes){#2};
	\fi
	\useasboundingbox (0,0.3) rectangle (\linewidth-2.9\pgflinewidth,\the\c@nbrlignes+0.8);
	\ifborder% 
	\draw [rounded corners](0,0.3) rectangle (\linewidth-2.9\pgflinewidth,\the\c@nbrlignes+0.8);
	\fi  
	\end{tikzpicture}
	\par
	\@LTRfalse    
	\@bordertrue
    \c@nbrlignes=2
}

% define \twoparts command  =====================================
\newcommand{\twoparts}[3][0.5]{%
	\par
	\begin{minipage}[t]{#1\textwidth}
		#2
	\end{minipage}
	\hfill
	\begin{minipage}[t]{\textwidth- #1\textwidth -3mm}
		#3
	\end{minipage}
	\par
}

% section format  =============================================
\newcount\c@note
\c@note=1
\def\note#1{\global\c@note=#1}
\def\formatnote#1{\begingroup\normalfont\footnotesize\color{red!60!black}\mbox{(\number\c@note\kern .5 ex  #1)}\endgroup} 

\titleformat{\section}
{\large\sffamily}{}{0em}{\underline{#1}%
	\ifnum\c@note>1 % 
	\ifnum\c@note>10 % 
	\formatnote{نقطة} %
	\else %
	\formatnote{نقاط} %
	\fi %
	\global\c@note=1
	\fi}

% define command \help =========================================
\def\bverb#1{\begingroup\englishfonttt \textcolor{blue}{#1}\endgroup}
\def\gverb#1{\begingroup\englishfonttt \footnotesize \textcolor{gray!40!black}{#1}
	\endgroup}




\long\def\help{%
    \fontsize{10}{15}
	\selectfont
	    \setRTL
	    
		الحزمة
		\bverb{sujet} 
		هي حزمة معدة لكتابة أوراق أسئلة للإختبارات، الفروض والواجبات، توفر التعليمة :
		
		\centerline{\LR{\bverb{\string\sujetset[<keys=value>]\{title\}}}}
		
		حيث 
		\bverb{keys}
		هي كلمات مفتاحية وهي بالتفصيل :
		\bigskip
		
		\begin{english}
		
		{\centering 
		\begin{tabular}{@{\hskip1em}lp{6cm}p{2.5cm}}
		\hline
		\englishfonttt key  & \englishfonttt definition &  \englishfonttt default\\
		\hline
		\bverb{etab}   &\textarabic{مؤسسة العمل}          & \gverb{\textarabic{اسم المؤسسة هنا}}\\
		\bverb{niveau} & \textarabic{المستوى الدراسي}   &    \gverb{\textarabic{1 ج م ع تك}}\\
		\bverb{duree}  & \textarabic{مدة الإختبار (الفرض)} &  \gverb{\textarabic{ساعة}}\\
		\bverb{nom}    & {\englishfonttt (boolean)}\textarabic{إطار لكتابة اسم الطالب}  & \gverb{false}\\
		\hline
		\end{tabular}
	    \par\bigskip  
         }
		
	    \end{english}
		
		إذا لم تحدد الكلمات المفتاحية في التعليمة
		\bverb{sujetset}
		فإن البرنامج يستعمل القيم الإفتراضية،
		والتي يمكن تغييرها بالملف sujet.sty
				
		\medskip
		
		\textcolor{red}{تعليمات إضافية}\\
		توفر الحزمة تعليمات للمساعدة هي :
		
		\begin{english}
				
		-\makebox[0.85\columnwidth][l]{\bverb{\LR{\string\solbox[<key=value>]\{text\}}}=\textarabic{إطار لكتابة الإجابة
		}}
		
		{\setRTL
			
			\textarabic{حيث الكلمات المفتاحية هي:}
		}
		
		
		\bigskip
		
		{\centering
		\begin{tabular}{@{\hskip1em}lp{6.5cm}p{1.5cm}}
		\hline 
		\englishfonttt key  & \englishfonttt definition &  \englishfonttt default\\
		\hline
		\bverb{lignes} & \textarabic{لتعيين عدد الأسطر بالإطار}                                         & 	\gverb{2}\\
		\bverb{LTR}    & {\englishfonttt (boolean)} \textarabic{اتجاه الكتابة من اليسار إلى اليمين } &  \gverb{false}\\
		\bverb{border} & {\englishfonttt (boolean)} \textarabic{لرسم أو إزالة الإطار}                   &  \gverb{true}\\
		\hline	
	    \end{tabular}
		\par }
		\bigskip
		
		-\bverb{\LR{\string\note\{n\}}} = \textarabic{لتعيين علامة لكل تمرين	} \hfill \gverb{(no default)}
		
		-\bverb{\LR{\string\twoparts[fraction]\{first part\}\{second part\}}} = \textarabic{تقسيم الصفحة إلى جزءين}	 \hfill \gverb{(default=0.5)}
		
		\end{english}
		
		
	\bigskip
}

\endinput
